# 时长计算功能修复说明

## 修复时间
2025年12月23日

## 问题描述
在管理面板的打卡记录中，时长列显示为"-"，没有正确记录和显示打卡的持续时间。

## 问题原因
在结束类型的打卡（如下班、回座）时，程序只在有正在进行中(ongoing)的记录时才会计算时长。但在某些情况下（如系统重启、数据库状态不一致等），即使有对应的开始记录，也可能找不到ongoing状态的记录，导致时长无法计算。

## 修复内容

### 文件修改
- `src-tauri/src/commands/checkin.rs`

### 具体修改
增强了时长计算的查找逻辑：

1. **优先查找ongoing记录**
   - 首先尝试从正在进行中的记录中查找配对的开始记录

2. **备用查找机制**
   - 如果没有找到ongoing记录，从今天的所有打卡记录中查找：
     - 下班(action_role=2) → 查找对应的上班记录(action_role=1)
     - 回座(action_role=4) → 查找对应的临时事件开始记录(action_role=3)
   - 选择最近的一条未配对的开始记录

3. **时长计算和标记**
   - 找到配对记录后，计算时长（分钟）
   - 对于下班：检查是否早退
   - 对于回座：检查是否超时

## 测试建议

### 正常流程测试
1. 上班 → 下班：应该显示工作时长
2. 上班 → 午餐 → 回座：应该显示午餐时长
3. 上班 → 上厕所 → 回座：应该显示上厕所时长

### 边界情况测试
1. 多次上班和下班：每次下班应该配对最近的上班记录
2. 多次临时事件：每次回座应该配对最近的临时事件开始

## 注意事项
- 管理员可以通过编辑功能手动调整迟到、早退、超时等标记
- 时长计算基于实际打卡时间，以分钟为单位
- 所有时间计算使用柬埔寨时区(Asia/Phnom_Penh)

## 安装包位置
`src-tauri/target/release/bundle/dmg/员工打卡系统_1.0.0_aarch64.dmg`
